<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>D3 v4 - force layout</title>
</head>

<body>
<div id="graph"></div>    
    
<script src="https://d3js.org/d3.v5.js"></script>    
<script>
!(function(){
    "use strict"
    
    var chartWidth = 900;
    var chartHeight = 500;
    var circleR = 2;
	var BasicUnit = 5*10e9;
    var svg = d3.select("#graph").append("svg").attr("id","svg")
        .attr("width",chartWidth)
        .attr("height",chartHeight);

    var rawData;
    var allDots;
    var dataByYear;
    var countries;
    
    
    main()
    
    function main() {
        d3.dsv(",", "GDP.csv").then(function(data){
		    DataParse(data);
            drawChart(dataByYear[1960]);  
            //DrawSVG(dataByYear, countries)
        });

    }
    
    function findById(d) {
        return d.id == this;
    }
    
    function DataParse(data) {
		rawData = data;
        allDots = new Array;
        dataByYear = new Object;
        var othersByYear = new Object;
        for (var year = 1960; year <= 2017; year++) {
            dataByYear[year] = new Object;
            dataByYear[year].nodes = new Array;
            dataByYear[year].links = new Array;
            othersByYear[year] = 0;
        }
        countries = new Array;
        // Deal with big parts
        data.forEach(element => {
        	countries.push(element["Country Code"]);
            for (var year = 1960; year <= 2017; year++) {
                var dotsThisYear = new Array;
                // insert all the nodes
                if (element[year] != "") {
                    var dataDots = Math.round(element[year]/BasicUnit);
                    if (dataDots == 0) othersByYear[year] = othersByYear[year] + parseInt(element[year]);
                    for (var i = 0; i < dataDots; i++) {
                        var id = element["Country Code"]+i;
                        var dot = allDots.find(findById, id);
                        if (dot == undefined) {
                            dot = new Object;
                            dot.id = id;
                            dot.code = element["Country Code"];
                            dot.r = 2;
                            allDots.push(dot);
                            dataByYear[year].nodes.push(dot);
                            dotsThisYear.push(id);
                        } else {
                            dataByYear[year].nodes.push(dot);
                            dotsThisYear.push(id);
                        }
                    }
                }
                // insert all the links
                for (var i = 0; i < dotsThisYear.length; i++) {
                    for (var j = i+1; j < dotsThisYear.length; j++) {
                        var link = new Object;
                        link.source = dotsThisYear[i];
                        link.target = dotsThisYear[j];
                        dataByYear[year].links.push(link);
                    }
                }
            }
        });
        // Deal with others
        countries.push("Others");
        for (var year = 1960; year <= 2017; year++) {
        	var dotsThisYear = new Array;
            var otherDots = Math.ceil(othersByYear[year]/BasicUnit);
            // insert all the nodes
			for (var i = 0; i < otherDots; i++) {
				var id = "Other"+i;
				var dot = allDots.find(findById, id);
				if (dot == undefined) {
					dot = new Object;
					dot.id = id;
					dot.code = "Others";
					dot.r = 2;
					allDots.push(dot);
					dataByYear[year].nodes.push(dot);
					dotsThisYear.push(id);
				} else {
					dataByYear[year].nodes.push(dot);
					dotsThisYear.push(id);
				}
			}
			// insert all the links
			for (var i = 0; i < dotsThisYear.length; i++) {
				for (var j = i+1; j < dotsThisYear.length; j++) {
					var link = new Object;
					link.source = dotsThisYear[i];
					link.target = dotsThisYear[j];
					dataByYear[year].links.push(link);
				}
			}
        }
	}
    
    function drawChart(data) {
        // Get the actural size of svg
		var svg = document.getElementById('svg');
		var width = svg.clientWidth;
		var height = svg.clientHeight;

		// scales
		var countryColor = d3.scaleOrdinal()
			.domain(countries)
			.range(d3.schemeSet3);

		// The nodes
		var svg = d3.select('#svg');
		var nodeArea = svg.append('g')
			.attr("id", "nodeArea");
		var nodes = nodeArea.selectAll(".node")
			.data(data.nodes)
			.enter()
			.append("circle")
			.attr("fill", function(d){return countryColor(d.code);})
			.attr("r", circleR);

        var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function(d) { return d.id }))
            .force("collide",d3.forceCollide( function(d){ return circleR }).iterations(16) )
            .force("charge", d3.forceManyBody())
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("y", d3.forceY(0))
            .force("x", d3.forceX(0))
        
        
        var ticked = function() {
            nodes
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });
        }  
        
        simulation
            .nodes(data.nodes)
            .on("tick", ticked);
    
        simulation.force("link")
            .links(data.links);    
        
                
    }

    function DrawSVG(data, countries) {
		// Get the actural size of svg
		var svg = document.getElementById('svg');
		var width = svg.clientWidth;
		var height = svg.clentHeight;

		// scales
		var countryColor = d3.scaleOrdinal()
			.domain(countries)
			.range(d3.schemeSet3);

		// The nodes
		var svg = d3.select('#svg');
		var nodeArea = svg.append('g')
			.attr("id", "nodeArea");
		var nodes = nodeArea.selectAll(".node")
			.data(data[1960].nodes)
			.enter()
			.append("circle")
			//.attr("fill", function(d){return countryColor(d.code);})
			.attr("r", circleR);

		
		// the simulation
		var simulation = d3.forceSimulation()
			.force("link", d3.forceLink().id(function(d){return d.id;}))
			.force("collide", d3.forceCollide(function(d){return circleR;}).iterations(16))
			.force("charge", d3.forceManyBody())
			.force("center", d3.forceCenter(width/2, height/2))
			.force("y", d3.forceY(0))
            .force("x", d3.forceX(0));
      	simulation.nodes(data[1960].nodes)
      		.on("tick", function(){
      			nodes
      				.attr("cx",function(d){return d.x;})
      				.attr("cy",function(d){return d.y;});
      		});
      	simulation.force("link").links(data[1960].links);

	}
}());
</script>    
</body>
</html>